<!DOCTYPE html>
<html >
<head>
  <meta charset="UTF-8">
  <title>Fate GM Tools</title>
  <!-- link rel="stylesheet" href="css/style.css?v=2" -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <style>
        @import url("https://fonts.googleapis.com/css?family=Open+Sans:400,600");
        @import url("https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css");
        *, *:before, *:after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100vh;
        }

        body {
            font: 600 12px/1 'Open Sans', sans-serif;
            color: #333;
            background: #333;
            overflow-x: hidden;
        }

        .wrapper {
            display: flex;
            min-height: 100%;
            background-color: #eee;
        }

        .sidebar {
            position: absolute;
            width: 220px;
            height: 100%;
            overflow-y: scroll;
            background-color: #fff;
        }

        .content {
            flex: 1;
            padding: 0px;
            background: #eee;
            transform: translate3d(0, 0, 0);
            transition: transform .3s;
        }

        .content.isOpen {
            transform: translate3d(220px, 0, 0);
        }

        .button {
            cursor: pointer;
            margin-left: 10px;
        }

        .button:before {
            content: '\f0c9';
            font: 42px fontawesome;
        }

        /* Demo Navigation */
        .title {
            font-size: 16px;
            font-weight: normal;
            line-height: 50px;
            text-align: left;
            padding-left: 20px;
            text-transform: uppercase;
            letter-spacing: 7px;
            color: #eee;
            background: #007fff;
        }

        .nav li a {
            position: relative;
            display: block;
            font-size: 12px;
            color: #222;
            cursor: pointer;
            padding: 0.5em;
            margin-left: 0px;
        }

        .nav li a:hover {
            background: #eee;
        }

        .ui-accordion .ui-accordion-content {
            padding-left: 0.5em !important;
            border-top: 0;
            overflow: auto;
        }

        .patreon {
            color: #eee;
            background: #F96854;
            cursor: pointer;
            text-align: center;
            justify-content: center;
            height: 36px;
        }

        .patreon a {
            color: #fff;
        }

        .token {
            width: 100px;
            height: 100px;
        }

        .sidebar {
            position: fixed;
        }

        #distance {
            display: none;
            position: relative;
            top: -10px;
            margin-left: 20px;
        }

        h1 {
            margin-top: 20px;
            font-size: 28px;
            font-weight: 400;
            text-align: center;
        }

        h2 {
            font-size: 12px;
            font-weight: 400;
            color: red;
            text-align: right;
            margin-right: 33px;
            margin-bottom: 20px;
            padding-top: 0px;
        }

        #screenshot{
            position:absolute;
            border:1px solid #ccc;
            background:#333;
            padding:5px;
            display:none;
            color:#fff;
            width: 200px;
        }

        /* Start by setting display:none to make this hidden.
           Then we position it in relation to the viewport window
           with position:fixed. Width, height, top and left speak
           for themselves. Background we set to 80% white with
           our animation centered, and no-repeating */
        .loading-modal {
            display:    none;
            position:   fixed;
            z-index:    1000;
            top:        0;
            left:       0;
            height:     100%;
            width:      100%;
            background: url('https://i.stack.imgur.com/FhHRx.gif')
            50% 50%
            no-repeat;
        }

        /* When the body has the loading class, we turn
           the scrollbar off with overflow:hidden */
        body.loading {
            overflow: hidden;
        }

        /* Anytime the body has the loading class, our
           modal element will be visible */
        body.loading .loading-modal {
            display: block;
        }
    </style>
</head>

<body>
  <div class='wrapper'>
      <div class='sidebar'>
        <h1>RPG Scene</h1>
        <h2>BETA VERSION</h2>
        <div id='accordion'>
            <div class='title'>Tools</div>
            <ul class='nav'>
              <li>
                <a onclick="addBlindBox()">Blind box</a>
              </li>
              <li>
                <a onclick="addBlindCircle()">Blind circle</a>
              </li>
              <hr />
              <li>
                <a onclick="openTextInputDialog()">Text</a>
              </li>
              <li>
                <a onclick="openTextInputDialog(true)">Character</a>
              </li>
              <li>
                <a onclick="openImageDialog()">Image from URL</a>
              </li>
                <hr />
              <li>
                <a onclick="saveSceneDialog()">Save scene</a>
              </li>
              <li>
                <a onclick="loadSceneDialog()">Load scene</a>
              </li>
            </ul>
            <div class='title'>Fate objects</div>
            <ul class='nav'>
                <li>
                    <a onclick="rollFateDice()">Roll dice!</a>
                </li>
                <li>
                    <a onclick="rollExtraDie()">Roll extra!</a>
                </li>
                <hr />
                <li>
                    <a onclick="addAspect()">Aspect</a>
                </li>
                <li>
                    <a onclick="addBoost()">Boost</a>
                </li>
                <li>
                    <a onclick="addPoint()">Fate point</a>
                </li>
                <hr />
                <li>
                    <a onclick="addFCSheet()">FC sheet</a>
                </li>
                <li>
                    <a onclick="addFAESheet()">FAE sheet</a>
                </li>
                <li>
                    <a onclick="addLadder()">Ladder</a>
                </li>
            </ul>
            <div class='title'>Help</div>
            <div>
                <ul class='nav'>
                  <li>
                    <a onclick="openHelpDialog()">Instructions</a>
                  </li>
                    <li>
                        <a onclick="openCreditsDialog()">Credits</a>
                    </li>
                </ul>
            </div>
        </div>
      </div>
      <div id="content" class='content isOpen'>
        <span id="distance"></span>
        <canvas id="c"></canvas>
      </div>

      <div class="loading-modal"></div>

      <div id="help-dialog" style="display: none;">
          <br/><br/>
          SPACE = Hold down to enable panning with mouse.<br/>
          F = Send selected object to front.<br/>
          B = Send selected object to back.<br/>
          Q = Bring selected object forward one layer.<br/>
          A = Push selected object back on layer.<br>
          C = Clone active object on top of source.<br/>
          R = Rotate active objects 45 degrees clockwise.<br/>
          L = Lock selected objects from editing.<br/>
          O = Open selected objects for editing.<br/>
          G = Group selected objects.<br/>
          U = Ungroup selected objects.<br/>
          M = Measure distance in feet from last clicked point.<br/>
          P = Hold down and use mouse to draw with pen.<br/>
          S = Toggle snap mode.<br/>
          Z = Zoom in<br/>
          X = Zoom out<br/>
          Delete or D = Remove selected items.<br/>
          Arrow keys = Move selected object.<br/><br>
          To select multiple items, hold down SHIFT and click on the items. Then you can group them.<br/><br/>
          To deselect items, right click on mouse.<br><br>
          To set location of next objects, click on the map first.<br/><br/>
          Use mouse scroll wheel to zoom in and out.<br/><br/>
      </div>

      <div id="credits-dialog" style="display: none;">
          <br/><br/>
          Development: Artur Gajewski<br/><br/>
      </div>
  </div>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.17/fabric.js"></script>
  <!-- script src="js/index.js?version=0.6"></script -->
  <script
  src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
  integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
  crossorigin="anonymous"></script>

  <script>
      $(document).ready(function() {
          $('.button').on('click', function() {
              $('.content').toggleClass('isOpen');
          });

          screenshotPreview();

          $(function() {
              $( "#accordion" ).accordion({
                  heightStyle: "content"
              });
          });
      });

      var canvas = new fabric.Canvas('c', { selection: true, preserveObjectStacking: true });
      var panning = false;
      var drawing = false;
      var drawingMode = false;
      var snap = false;
      var grid = 50; // How many pixels is one grid on map
      var canvasScale = 1;
      var SCALE_FACTOR = 1.01;
      var currentX = 100;
      var currentY = 100;
      var zoomLevel = 0;
      var zoomLevelMin = -20;
      var zoomLevelMax = 50;
      var mouseDownPoint = null;
      var currentCanvasId = null;

      canvas.setWidth($('#content').width());
      canvas.setHeight($('#content').height());

      bindActionListeners();

      canvas.on('mouse:down', function(event) {
          var pointer = canvas.getPointer(event.e);
          currentX = pointer.x;
          currentY = pointer.y;
          //if (!drawingMode && !canvas.getActiveObject() && !canvas.getActiveGroup()) {
          //    canvas.selection = false;
          //    panning = true;
          //}
      });

      canvas.on('mouse:up', function() {
          if (!canvas.getActiveObject()) {
              canvas.selection = true;
              panning = false;
          }
      }).on('mouse:move', function (e) {
          if (panning && e && e.e) {
              var units = 10;
              var delta = new fabric.Point(e.e.movementX, e.e.movementY);
              canvas.relativePan(delta);
          }
          var pointer = canvas.getPointer(e.e);
          var distance = calculateDistace(pointer.x, pointer.y, currentX, currentY);
          $("#distance").text("Distance: " + ((distance / grid).toFixed(1) * 5) + " feet");
      }).on('object:moving', function(options) {
          if (snap) {
              options.target.set({
                  left: Math.round(options.target.left / grid) * grid,
                  top: Math.round(options.target.top / grid) * grid
              });
          } else {
              options.target.set({
                  left: Math.round(options.target.left / 1) * 1,
                  top: Math.round(options.target.top / 1) * 1
              });
          }
      });

      function bindActionListeners() {

          // Clear selections on right click
          $('#content').bind('contextmenu', function (event) {
              event.preventDefault();
              if (canvas.getActiveObject()) {
                  canvas.discardActiveObject();
                  canvas.renderAll();
              }
              if (canvas.getActiveGroup()) {
                  canvas.discardActiveGroup();
                  canvas.renderAll();
              }
          });

          // Chrome, Opera, IE scroll wheel zoom
          $("#content").bind('mousewheel', function(event) {
              event.preventDefault();
              var delta = event.originalEvent.wheelDelta;
              if (delta != 0) {
                  var pointer = canvas.getPointer(event.e, true);
                  var point = new fabric.Point(pointer.x, pointer.y);
                  if (delta > 0) {
                      zoomIn(point);
                  } else if (delta < 0) {
                      zoomOut(point);
                  }
              }
          });

          // Hack for Firefox in order to make scroll wheel zoom work
          $("#content").bind('DOMMouseScroll', function(event) {
              event.preventDefault();
              var point = new fabric.Point(canvas.getWidth() / 2, canvas.getHeight() / 2);
              if(event.originalEvent.detail > 0) {
                  zoomOut(point);
              }else {
                  zoomIn(point);
              }
          });

          // Observe if text editing mode is on, disable key events
          canvas.observe('text:editing:entered', function() {
              panning = false;
              $(document).off();
          });

          // Observe if text editing mode is exited, enable key events
          canvas.observe('text:editing:exited', function() {
              panning = false;
              bindActionListeners();
          });

          $(document).bind('keydown', function(event) {
              // Enable panning mode
              if ( event.which == 32 && event ) {
                  event.preventDefault();
                  panning = true;
              }
          });

          $(document).bind('keyup', function(event) {
              if (canvas.getActiveGroup()) {
                  // Group objects
                  if ( event.which == 71 && event ) {
                      event.preventDefault();
                      groupObjects();
                  }
              }

              if (canvas.getActiveObject()) {
                  // Ungroup objects
                  if ( event.which == 85 && event ) {
                      event.preventDefault();
                      unGroupObjects();
                  }

                  // Lock object
                  if ( event.which == 76 && event ) {
                      event.preventDefault();
                      lockObject();
                  }

                  // Open object
                  if ( event.which == 79 && event ) {
                      event.preventDefault();
                      openObject();
                  }

                  // Rotate object
                  if ( event.which == 82 && event ) {
                      event.preventDefault();
                      var curAngle = canvas.getActiveObject().getAngle();
                      canvas.getActiveObject().setAngle(curAngle+45);
                      canvas.renderAll();
                  }

                  // Left arrow key
                  if ( event.which == 37 && event ) {
                      event.preventDefault();
                      canvas.getActiveObject().left -= grid;
                      canvas.getActiveObject().setCoords();
                      canvas.renderAll();
                  }

                  // Right arrow key
                  if ( event.which == 39 && event ) {
                      event.preventDefault();
                      canvas.getActiveObject().left += grid;
                      canvas.getActiveObject().setCoords();
                      canvas.renderAll();
                  }

                  // Up arrow key
                  if ( event.which == 38 && event ) {
                      event.preventDefault();
                      canvas.getActiveObject().top -= grid;
                      canvas.getActiveObject().setCoords();
                      canvas.renderAll();
                  }

                  // Down arrow key
                  if ( event.which == 40 && event ) {
                      event.preventDefault();
                      canvas.getActiveObject().top += grid;
                      canvas.getActiveObject().setCoords();
                      canvas.renderAll();
                  }


              }

              // Remove active object and object groups
              if ( (event.which == 46 || event.which == 68) && event) {
                  event.preventDefault();
                  var activeObject = canvas.getActiveObject();
                  var activeGroup = canvas.getActiveGroup();
                  if (activeObject) {
                      if (confirm('Are you sure you want to delete this?')) {
                          canvas.remove(activeObject);
                      }
                  } else if (activeGroup) {
                      if (confirm('Are you sure you want to delete these?')) {
                          var objectsInGroup = activeGroup.getObjects();
                          canvas.discardActiveGroup();
                          objectsInGroup.forEach(function(object) {
                              canvas.remove(object);
                          });
                      }
                  }
              }

              // Toggle measurement
              if ( event.which == 77 && event ) {
                  event.preventDefault();
                  $("#distance").toggle();
              }

              // Disable panning mode
              if ( event.which == 32 && event ) {
                  event.preventDefault();
                  panning = false;
              }

              // Clone an object
              if ( event.which == 67 && event ) {
                  event.preventDefault();
                  if (canvas.getActiveObject()) {
                      var object = fabric.util.object.clone(canvas.getActiveObject());
                      canvas.add(object);
                  }
              }

              // toggle drawing mode
              if ( event.which == 80 && event ) {
                  event.preventDefault();
                  if (canvas.isDrawingMode == false) {
                      panning = false;
                      drawingMode = true;
                      canvas.isDrawingMode = true;
                      canvas.freeDrawingBrush.color = 'Red';
                      canvas.freeDrawingBrush.width = 5;
                  } else {
                      panning = false;
                      drawingMode = false;
                      canvas.isDrawingMode = false;
                  }
              }

              // Enable snap
              if ( event.which == 83 && event ) {
                  event.preventDefault();
                  snap = snap != true;
              }

              // Bring active object to front
              if ( event.which == 70 && event ) {
                  event.preventDefault();
                  canvas.getActiveObject().bringToFront();
                  canvas.discardActiveObject();
                  canvas.renderAll();
              }

              // Bring active object to back
              if ( event.which == 66 && event ) {
                  event.preventDefault();
                  canvas.getActiveObject().sendToBack();
                  canvas.discardActiveObject();
                  canvas.renderAll();
              }

              // Bring active object forward
              if ( event.which == 81 && event ) {
                  event.preventDefault();
                  canvas.getActiveObject().bringForward();
                  canvas.discardActiveObject();
                  canvas.renderAll();
              }

              // Send active object backwards
              if ( event.which == 65 && event ) {
                  event.preventDefault();
                  canvas.getActiveObject().sendBackwards();
                  canvas.discardActiveObject();
                  canvas.renderAll();
              }

              // Zoom in one level
              if ( event.which == 90 && event ) {
                  event.preventDefault();
                  var point = new fabric.Point(canvas.getWidth() / 2, canvas.getHeight() / 2);
                  zoomIn(point);
              }

              // Zoom out one level
              if ( event.which == 88 && event ) {
                  event.preventDefault();
                  var point = new fabric.Point(canvas.getWidth() / 2, canvas.getHeight() / 2);
                  zoomOut(point);
              }
          });
      }

      function zoomIn(point) {
          if (zoomLevel < zoomLevelMax) {
              zoomLevel++;
              canvas.zoomToPoint(point, Math.pow(1.1, zoomLevel));
              keepPositionInBounds(canvas);
          }
      }

      function zoomOut(point) {
          if (zoomLevel > zoomLevelMin) {
              zoomLevel--;
              canvas.zoomToPoint(point, Math.pow(1.1, zoomLevel));
              keepPositionInBounds(canvas);
          }
      }

      function calculateDistace(x1, y1, x2, y2) {
          return Math.sqrt(Math.pow(x2*1-x1*1, 2)+Math.pow(y2*1-y1*1, 2));
      }

      function keepPositionInBounds() {
          var zoom = canvas.getZoom();
          var xMin = (2 - zoom) * canvas.getWidth() / 2;
          var xMax = zoom * canvas.getWidth() / 2;
          var yMin = (2 - zoom) * canvas.getHeight() / 2;
          var yMax = zoom * canvas.getHeight() / 2;

          var point = new fabric.Point(canvas.getWidth() / 2, canvas.getHeight() / 2);
          var center = fabric.util.transformPoint(point, canvas.viewportTransform);

          canvas.relativePan(new fabric.Point(0, 0));
      }

      function lockObject() {
          var activeObject = canvas.getActiveObject();
          if (activeObject) {
              activeObject.set({
                  "lockMovementX": true,
                  "lockMovementY": true,
                  "lockScalingX": true,
                  "lockScalingY": true,
                  "lockRotation": true
              });
              canvas.renderAll();
          }
      };

      function openObject() {
          var activeObject = canvas.getActiveObject();
          if (activeObject) {
              activeObject.set({
                  "lockMovementX": false,
                  "lockMovementY": false,
                  "lockScalingX": false,
                  "lockScalingY": false,
                  "lockRotation": false
              });
              canvas.renderAll();
          }
      };

      function groupObjects() {
          var activegroup = canvas.getActiveGroup();
          if (activegroup) {
              var objectsInGroup = activegroup.getObjects();
              activegroup.clone(function(newgroup) {
                  canvas.discardActiveGroup();
                  objectsInGroup.forEach(function(object) {
                      canvas.remove(object);
                  });
                  canvas.add(newgroup);
                  canvas.renderAll();
              });
          }
      };

      function unGroupObjects() {
          var activeObject = canvas.getActiveObject();
          if (activeObject) {
              if(activeObject.type=="group"){
                  var items = activeObject._objects;
                  activeObject._restoreObjectsState();
                  canvas.remove(activeObject);
                  for(var i = 0; i < items.length; i++) {
                      canvas.add(items[i]);
                      canvas.item(canvas.size()-1).hasControls = true;
                  }
                  canvas.renderAll();
              }
          }
      };

      function addImage(url, width) {
          $("body").addClass("loading");

          fabric.Image.fromURL(url, function (oImg) {
              canvas.add(oImg.scaleToWidth(width));
              canvas.renderAll();
              $("body").removeClass("loading");

          }, {"left": currentX, "top": currentY});
      }

      function addStyledText(text, size) {
          var text = new fabric.IText(" " + text +" ", { textBackgroundColor: '#fff', shadow: 'rgba(0,0,0,0.3) 5px 5px 5px', fontSize: size, left: currentX, top: currentY });
          canvas.add(text);
      }

      function addText(text, size) {
          var text = new fabric.IText(" " + text +" ", { fontSize: size, left: currentX, top: currentY });
          canvas.add(text);
      }

      function addBlindBox() {
          var rect = new fabric.Rect({
              left: currentX,
              top: currentY,
              fill: 'black',
              width: 100,
              height: 100
          });
          canvas.add(rect);
          rect.bringToFront();
      }

      function addBlindCircle() {
          var circle = new fabric.Circle({
              left: currentX,
              top: currentY,
              fill: 'black',
              radius: 50,
          });
          canvas.add(circle);
          circle.bringToFront();
      }

      function addAspect() {
          var text = new fabric.Textbox("\n\n", {
              width: 200,
              textAlign: 'center',
              fontSize: 20,
              left: currentX,
              top: currentY,
              backgroundColor: '#FFFFA5',
              maxWidth: 300,
              minWidth: 100,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px'
          });

          canvas.add(text);
      }

      function addBoost() {
          var text = new fabric.Textbox("\n\n", {
              width: 200,
              textAlign: 'center',
              fontSize: 20,
              left: currentX,
              top: currentY,
              backgroundColor: '#a1d4ec',
              maxWidth: 300,
              minWidth: 100,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px'
          });

          canvas.add(text);
      }

      function addFCSheet() {
          var sheet = "\n" +
              "   NAME: \n" +
              "   REFRESH: 3\n" +
              "\n" +
              "   ASPECTS\n" +
              "     High Concept: \n" +
              "     Trouble: \n" +
              "\n" +
              "   SKILLS\n" +
              "     Great (+4): \n" +
              "     Good (+3): \n" +
              "     Fair (+2): \n" +
              "\n" +
              "   STUNTS\n" +
              "     - \n" +
              "     - \n" +
              "     - \n" +
              "\n" +
              "   STRESS\n" +
              "     Physical OOOO\n" +
              "     Mental OOO\n" +
              "\n" +
              "   CONSEQUENCES\n" +
              "     Mild (2): \n" +
              "     Moderate (4): \n" +
              "     Severe (6):\n";

          var text = new fabric.Textbox(sheet, {
              width: 400,
              textAlign: 'left',
              fontSize: 14,
              left: currentX,
              top: currentY,
              backgroundColor: '#fff',
              maxWidth: 300,
              minWidth: 100,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px'
          });

          canvas.add(text);
      }

      function addFAESheet() {
          var sheet = "\n" +
              "   NAME: \n" +
              "   REFRESH: 3\n" +
              "\n" +
              "   ASPECTS\n" +
              "     High Concept: \n" +
              "     Trouble: \n" +
              "\n" +
              "   APPROACHES\n" +
              "     Careful: \n" +
              "     Clever: \n" +
              "     Flashy: \n" +
              "     Forceful: \n" +
              "     Quick: \n" +
              "     Sneaky: \n" +
              "\n" +
              "   STUNTS\n" +
              "     - \n" +
              "     - \n" +
              "     - \n" +
              "\n" +
              "   STRESS\n" +
              "   OOO\n" +
              "\n" +
              "   CONSEQUENCES\n" +
              "     Mild (2): \n" +
              "     Moderate (4): \n" +
              "     Severe (6):\n";

          var text = new fabric.Textbox(sheet, {
              width: 400,
              textAlign: 'left',
              fontSize: 14,
              left: currentX,
              top: currentY,
              backgroundColor: '#fff',
              maxWidth: 300,
              minWidth: 100,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px'
          });

          canvas.add(text);
      }

      function addLadder() {
          var sheet = "\n" +
              "   LADDER \n" +
              "\n" +
              "   +8   Legendary\n" +
              "   +7   Epic\n" +
              "   +6   Fantastic\n" +
              "   +5   Superb\n" +
              "   +4   Great\n" +
              "   +3   Good\n" +
              "   +2   Fair\n" +
              "   +1   Average\n" +
              "   0    Mediocre\n" +
              "   -1   Poor\n" +
              "   -2   Terrible\n" +
              "\n";

          var text = new fabric.Textbox(sheet, {
              width: 400,
              textAlign: 'left',
              fontSize: 14,
              left: currentX,
              top: currentY,
              backgroundColor: '#fff',
              maxWidth: 300,
              minWidth: 100,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px'
          });

          canvas.add(text);
      }

      function addAspectWithInvokes(text, size, invokeAmount) {
          var text = new fabric.Textbox("\n" + text + "\n", {
              width: 200,
              textAlign: 'center',
              fontSize: size,
              left: currentX,
              top: currentY + 30,
              backgroundColor: 'white',
              maxWidth: 300,
              minWidth: 100,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px'
          });

          for (i = 0; i < invokeAmount; i++) {
              var rect = new fabric.Rect({
                  left: currentX + (30 * i),
                  top: currentY,
                  fill: 'white',
                  width: 25,
                  height: 25,
                  stroke: 'black',
                  strokeWidth: 1,
                  shadow: 'rgba(0,0,0,0.3) 5px 5px 5px'
              });
              canvas.add(rect);
          }

          canvas.add(text);
      }

      function rollFateDice() {
          var die1 = new fabric.Textbox(getRandomFateDice(), {
              width: 50,
              textAlign: 'center',
              fontSize: 40,
              left: currentX + (60 * 0),
              top: currentY,
              backgroundColor: '#007fff',
              fill: 'white',
              minWidth: 50,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px',
              fontFamily: 'Comic Sans'
          });

          var die2 = new fabric.Textbox(getRandomFateDice(), {
              width: 50,
              textAlign: 'center',
              fontSize: 40,
              left: currentX + (60 * 1),
              top: currentY,
              backgroundColor: '#007fff',
              fill: 'white',
              minWidth: 50,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px',
              fontFamily: 'Comic Sans'
          });

          var die3 = new fabric.Textbox(getRandomFateDice(), {
              width: 50,
              textAlign: 'center',
              fontSize: 40,
              left: currentX + (60 * 2),
              top: currentY,
              backgroundColor: '#007fff',
              fill: 'white',
              minWidth: 50,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px',
              fontFamily: 'Comic Sans'
          });

          var die4 = new fabric.Textbox(getRandomFateDice(), {
              width: 50,
              textAlign: 'center',
              fontSize: 40,
              left: currentX + (60 * 3),
              top: currentY,
              backgroundColor: '#007fff',
              fill: 'white',
              minWidth: 50,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px',
              fontFamily: 'Comic Sans'
          });

          //group all the die together
          var alltogetherObj = new fabric.Group(
              [die1, die2, die3, die4],
              {
                  originX:'center',
                  originY:'center'
              }
          );

          canvas.add(alltogetherObj);

      }

      function rollExtraDie() {
          var die1 = new fabric.Textbox(getRandomFateDice(), {
              width: 50,
              textAlign: 'center',
              fontSize: 40,
              left: currentX + (60 * 0),
              top: currentY,
              backgroundColor: '#007fff',
              fill: 'white',
              minWidth: 50,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px',
              fontFamily: 'Comic Sans'
          });

          //group all the die together
          var alltogetherObj = new fabric.Group(
              [die1],
              {
                  originX:'center',
                  originY:'center'
              }
          );

          canvas.add(alltogetherObj);

      }

      function getRandomFateDice() {
          var number = Math.floor(Math.random() * Math.floor(3));
          if (number == 0) return '-';
          if (number == 1) return ' ';
          if (number == 2) return '+';
      }

      function addInvokeBox() {
          var rect = new fabric.Rect({
              left: currentX,
              top: currentY,
              fill: 'white',
              width: 25,
              height: 25,
              stroke: 'black',
              strokeWidth: 1,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px'
          });
          canvas.add(rect);
          rect.bringToFront();
      }

      function addPoint() {
          var circle = new fabric.Circle({
              left: currentX,
              top: currentY,
              fill: 'yellow',
              radius: 25,
              stroke: 'black',
              strokeWidth: 1,
              shadow: 'rgba(0,0,0,0.3) 5px 5px 5px'
          });
          canvas.add(circle);
          circle.bringToFront();
      }

      function loadMap(url) {
          $("body").addClass("loading");

          fabric.Image.fromURL(url, function(oImg){
              canvas.setBackgroundImage(oImg, canvas.renderAll.bind(canvas), {
                  backgroundImageOpacity: 0.5,
                  backgroundImageStretch: false
              });
              $("body").removeClass("loading");
          });

          canvas.setWidth($('#content').width());
          canvas.setHeight($('#content').height());
      }

      function saveAsPng() {
          window.open(canvas.toDataURL('png'));
      }



      function saveSceneDialog() {
          var json = JSON.stringify( canvas.toJSON() );
          var sceneStorage = window.localStorage;
          var sceneId = Math.floor(100000 + Math.random() * 900000)
          sceneStorage.setItem(sceneId, json);

          $('<form><input id="sceneid" type="text" style="z-index:10000; width: 50%" name="sceneid" value="' + sceneId + '"><br></form>').dialog({
              modal: true,
              title: "Scene was saved. Refer to the following ID to load it again!",
              width: "50%",
              maxWidth: "600px",
              buttons: {
                  'OK': function () {
                      bindActionListeners();
                      $(this).dialog('close');
                      $(this).dialog('destroy');
                  }
              }
          });

          $(document).off();

          $(document).bind('keypress', function(event) {
              // Disable Enter key press
              if ( event.which == 13 && event ) {
                  event.preventDefault();
              }
          });
      }

      function loadSceneDialog() {
          var sceneStorage = window.localStorage;

          $('<form><input id="sceneid" type="text" style="z-index:10000; width: 50%" name="sceneid"><br></form>').dialog({
              modal: true,
              title: "Enter scene ID",
              width: "50%",
              maxWidth: "600px",
              buttons: {
                  'OK': function () {
                      var sceneId = $('input[name="sceneid"]').val();

                      bindActionListeners();
                      $(this).dialog('close');
                      $(this).dialog('destroy');

                      var json = sceneStorage.getItem(sceneId);

                      canvas.loadFromJSON(json);
                      canvas.renderAll();
                      //canvas.calculateOffset();

                  },
                  'Cancel': function () {
                      bindActionListeners();
                      $(this).dialog('close');
                      $(this).dialog('destroy');
                  }
              }
          });

          $(document).off();

          $(document).bind('keydown', function(event) {
              // Disable Enter key press
              if ( event.which == 13 && event ) {
                  event.preventDefault();
              }
          });
      }

      function openMapDialog() {
          $('<form><br/><input id="mapurl" type="text" style="z-index:10000; width: 90%" name="url"><br></form>').dialog({
              modal: true,
              title: "Enter map URL",
              width: "50%",
              maxWidth: "600px",
              buttons: {
                  'OK': function () {
                      var url = $('input[name="url"]').val();
                      loadMap(url);
                      bindActionListeners();
                      $(this).dialog('close');
                      $(this).dialog('destroy');
                  },
                  'Cancel': function () {
                      bindActionListeners();
                      $(this).dialog('close');
                      $(this).dialog('destroy');
                  }
              }
          });

          $(document).off();

          $(document).bind('keydown', function(event) {
              // Disable Enter key press
              if ( event.which == 13 && event ) {
                  event.preventDefault();
              }
          });
      }

      function openImageDialog() {
          $('<form><br/><input id="mapurl" type="text" style="z-index:10000; width: 90%" name="url"><br></form>').dialog({
              modal: true,
              title: "Enter image URL",
              width: "50%",
              maxWidth: "600px",
              buttons: {
                  'OK': function () {
                      var url = $('input[name="url"]').val();
                      addImage(url, grid);
                      bindActionListeners();
                      $(this).dialog('close');
                      $(this).dialog('destroy');
                  },
                  'Cancel': function () {
                      bindActionListeners();
                      $(this).dialog('close');
                      $(this).dialog('destroy');
                  }
              }
          });

          $(document).off();

          $(document).bind('keydown', function(event) {
              // Disable Enter key press
              if ( event.which == 13 && event ) {
                  event.preventDefault();
              }
          });
      }

      function openTextInputDialog(styled = false) {
          $('<form><br/><input type="text" style="z-index:10000; width: 90%" name="maptext"><br></form>').dialog({
              modal: true,
              title: "Enter text",
              width: "50%",
              maxWidth: "600px",
              buttons: {
                  'OK': function () {
                      var text = $('input[name="maptext"]').val();
                      styled ? addStyledText(text, 20) : addText(text, 20);
                      bindActionListeners();
                      $(this).dialog('close');
                      $(this).dialog('destroy');
                  },
                  'Cancel': function () {
                      bindActionListeners();
                      $(this).dialog('close');
                      $(this).dialog('destroy');
                  }
              }
          });

          $(document).off();

          $(document).bind('keydown', function(event) {
              // Disable Enter key press
              if ( event.which == 13 && event ) {
                  event.preventDefault();
              }
          });
      }

      function openAspectInputDialog(invokeAmount) {
          $('<form><br/><input type="text" style="z-index:10000; width: 90%" name="maptext"><br></form>').dialog({
              modal: true,
              title: "Aspect phrase",
              width: "50%",
              maxWidth: "600px",
              buttons: {
                  'OK': function () {
                      var text = $('input[name="maptext"]').val();
                      addAspectWithInvokes(text, 20, invokeAmount);
                      bindActionListeners();
                      $(this).dialog('close');
                      $(this).dialog('destroy');
                  },
                  'Cancel': function () {
                      bindActionListeners();
                      $(this).dialog('close');
                      $(this).dialog('destroy');
                  }
              }
          });

          $(document).off();

          $(document).bind('keydown', function(event) {
              // Disable Enter key press
              if ( event.which == 13 && event ) {
                  event.preventDefault();
              }
          });
      }

      function openHelpDialog() {
          $('#help-dialog').dialog({
              modal: true,
              title: "Key mappings and help",
              width: "50%",
              maxWidth: "600px",
              buttons: {
                  'OK': function () {
                      $(this).dialog('close');
                  }
              }
          });
      }

      function openCreditsDialog() {
          $('#credits-dialog').dialog({
              modal: true,
              title: "Credits",
              width: "50%",
              maxWidth: "600px",
              buttons: {
                  'OK': function () {
                      $(this).dialog('close');
                  }
              }
          });
      }

      /*
       * Url preview script
       * powered by jQuery (https://www.jquery.com)
       *
       * written by Alen Grakalic (https://cssglobe.com)
       *
       * for more info visit https://cssglobe.com/post/1695/easiest-tooltip-and-image-preview-using-jquery
       *
       */
      this.screenshotPreview = function(){
          xOffset = 10;
          yOffset = 30;
          $("a.screenshot").hover(function(e){
                  this.t = this.title;
                  this.title = "";
                  var c = (this.t != "") ? "<br/>" + this.t : "";
                  $("body").append("<p id='screenshot'><img width='200' src='"+ this.rel +"' alt='url preview' />"+ c +"</p>");
                  $("#screenshot")
                      .css("top",(e.pageY - xOffset) + "px")
                      .css("left",(e.pageX + yOffset) + "px")
                      .fadeIn("fast");
              },
              function(){
                  this.title = this.t;
                  $("#screenshot").remove();
              });

          $("a.screenshot").mousemove(function(e) {
              $("#screenshot")
                  .css("top",(e.pageY - xOffset) + "px")
                  .css("left",(e.pageX + yOffset) + "px");
          });
      };

  </script>
</body>
</html>
